{"version":3,"file":"CollapsibleBodyContent.native.js","sources":["../../../../../src/components/Collapsible/CollapsibleBodyContent.native.tsx"],"sourcesContent":["import type { ReactElement } from 'react';\nimport { useCallback, useEffect, useState } from 'react';\nimport styled from 'styled-components/native';\nimport Animated, {\n  runOnJS,\n  useAnimatedStyle,\n  useSharedValue,\n  withTiming,\n} from 'react-native-reanimated';\nimport type { LayoutChangeEvent, ViewStyle } from 'react-native';\nimport { View } from 'react-native';\nimport type { CollapsibleBodyContentProps } from './types';\nimport { useCollapsible } from './CollapsibleContext';\nimport {\n  getCollapsibleBodyContentBoxProps,\n  getOpacity,\n  getTransitionDuration,\n  getTransitionEasing,\n} from './commonStyles';\nimport { nativeStyles } from './styles.native';\nimport { Box } from '~components/Box';\nimport { useTheme } from '~components/BladeProvider';\nimport { castNativeType } from '~utils';\n\ntype AnimatedStyledCollapsibleBodyContentProps = {\n  isExpanded: boolean;\n};\n\nconst AnimatedStyledCollapsibleBodyContent = styled(\n  Animated.View,\n)<AnimatedStyledCollapsibleBodyContentProps>(() => {\n  return {\n    overflow: 'hidden',\n  };\n});\n\nconst CollapsibleBodyContent = ({\n  children,\n  _hasMargin,\n}: CollapsibleBodyContentProps): ReactElement => {\n  const { isExpanded, direction } = useCollapsible();\n  const { theme } = useTheme();\n\n  const opacity = useSharedValue(getOpacity({ isExpanded }));\n\n  // `undefined` implies no height restrictions which is analogous to `auto` on web\n  const height = useSharedValue(isExpanded ? undefined : 0);\n  const [layoutHeight, setLayoutHeight] = useState(0);\n\n  // Keeps track of running animation to control absolute / relative positioning and handling layout event\n  const [isAnimating, setIsAnimating] = useState(false);\n  const onAnimationComplete = useCallback((): void => {\n    // Only mark the animation complete before the next repaint, otherwise, sometimes leads to state update delays when you try to quickly toggle multiple times\n    requestAnimationFrame(() => setIsAnimating(false));\n  }, []);\n\n  const duration = castNativeType(getTransitionDuration(theme));\n  const easing = castNativeType(getTransitionEasing(theme));\n\n  useEffect(() => {\n    setIsAnimating(true);\n\n    opacity.value = withTiming(getOpacity({ isExpanded }), { duration, easing });\n    height.value = withTiming(\n      // Animates the height to the measured value\n      isExpanded && layoutHeight ? layoutHeight : 0,\n      { duration, easing },\n      (isComplete) => {\n        // Only run this if the animation ran uninterrupted, for eg collapsing the content before it expanded fully\n        if (isComplete) {\n          // The callback `onAnimationComplete` has to be declared outside this, on JS thread\n          runOnJS(onAnimationComplete)();\n        }\n      },\n    );\n  }, [isExpanded, opacity, duration, easing, height, layoutHeight, onAnimationComplete]);\n\n  const animatedStyles = useAnimatedStyle(\n    (): ViewStyle => {\n      return {\n        opacity: opacity.value,\n        height: height.value,\n      };\n    },\n  );\n\n  /**\n   * Tracks the height of content so we can animate height to and from 0 to the content's height.\n   * **Note:** We can't animate height from 0 to auto or vice-versa.\n   */\n  const onLayout: (event: LayoutChangeEvent) => void = useCallback(\n    (event) => {\n      if (isAnimating) {\n        if (event.nativeEvent.layout.height > layoutHeight) {\n          /**\n           * During animation, we set `layoutHeight` if the native event's layout height is larger.\n           *\n           * The greater than comparison is needed because sometimes the native event's layout height is smaller than actual content height ðŸ¤¯\n           * For example, this happens if you try to render a lengthy `Text` that wraps onto multiple lines.\n           * In this case the initial native event's layout height only counts height of `Text` as if it were single line.\n           * So, when the `Text` actually renders on screen and wraps, another `nativeEvent` is triggered which gives us the actual content height.\n           * `nativeEvent` is triggered multiple times during animation but we only set `layoutHeight` if the height value is greater, hence the check.\n           */\n          setLayoutHeight(event.nativeEvent.layout.height);\n        }\n      } else if (event.nativeEvent.layout.height !== layoutHeight) {\n        /**\n         * When not animating, we set `layoutHeight` anytime `nativeEvent` layout height changes.\n         * This handles userland dynamic content inside the slot.\n         */\n        setLayoutHeight(event.nativeEvent.layout.height);\n      }\n    },\n    [layoutHeight, isAnimating],\n  );\n\n  return (\n    <AnimatedStyledCollapsibleBodyContent isExpanded={isExpanded} style={animatedStyles}>\n      <View\n        onLayout={onLayout}\n        /**\n         * This View is positioned absolute in collapsed state so `onLayout` can capture the height of the content.\n         * During animation, it's positioned relative so height related animation can happen, pushing adjacent content down or up.\n         */\n        style={\n          isExpanded || isAnimating\n            ? nativeStyles.collapsibleBodyExpanded\n            : nativeStyles.collapsibleBodyCollapsed\n        }\n      >\n        <Box {...getCollapsibleBodyContentBoxProps({ direction, _hasMargin })}>{children}</Box>\n      </View>\n    </AnimatedStyledCollapsibleBodyContent>\n  );\n};\n\nexport { CollapsibleBodyContent };\n"],"names":["AnimatedStyledCollapsibleBodyContent","styled","Animated","View","overflow","CollapsibleBodyContent","_ref","children","_hasMargin","_useCollapsible","useCollapsible","isExpanded","direction","_useTheme","useTheme","theme","opacity","useSharedValue","getOpacity","height","undefined","_useState","useState","_useState2","_slicedToArray","layoutHeight","setLayoutHeight","_useState3","_useState4","isAnimating","setIsAnimating","onAnimationComplete","useCallback","requestAnimationFrame","duration","castNativeType","getTransitionDuration","easing","getTransitionEasing","useEffect","value","withTiming","isComplete","runOnJS","animatedStyles","useAnimatedStyle","onLayout","event","nativeEvent","layout","_jsx","style","nativeStyles","collapsibleBodyExpanded","collapsibleBodyCollapsed","Box","Object","assign","getCollapsibleBodyContentBoxProps"],"mappings":"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"}